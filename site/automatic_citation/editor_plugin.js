(function(){tinymce.PluginManager.requireLangPack('jresearch');var _regexp=null;var _htmlTagsRegexp=null;var TinyMCE_JResearch_Automatic_Citation_Plugin={init:function(ed,url){var t=this,s={},vp;t.editor=ed;_regexp=new RegExp("(cite|citep|citeyear|nocite){((?:\\s*[-a-zA-Z0-9:.+_/]+\\s*,)*\\s*[-a-zA-Z0-9:.+_/]+\\s*)}|(bibliography){}","g");_htmlTagsRegexp=new RegExp("<(b|u|br|i|/br|/b|/u|/i)>","g");ed.addCommand('mceGenerateBib',function(){ed.execCommand('mceInsertContent',false,'bibliography{}')});ed.addCommand('mceCite',function(){ed.execCommand('mceInsertContent',false,'cite{')});ed.addCommand('mceCiteP',function(){ed.execCommand('mceInsertContent',false,'citep{')});ed.addCommand('mceCiteYear',function(){ed.execCommand('mceInsertContent',false,'citeyear{')});ed.addCommand('mceNoCite',function(){ed.execCommand('mceInsertContent',false,'nocite{')});ed.onKeyUp.add(this._handleEvent);ed.addButton('cite_',{title:'jresearch.cite',cmd:'mceCite',image:url+'/images/cite.png'});ed.addButton('citep',{title:'jresearch.citep',cmd:'mceCiteP',image:url+'/images/citep.png'});ed.addButton('citeyear',{title:'jresearch.citeyear',cmd:'mceCiteYear',image:url+'/images/citeyear.png'});ed.addButton('nocite',{title:'jresearch.nocite',cmd:'mceNoCite',image:url+'/images/nocite.png'});ed.addButton('bibliography',{title:'jresearch.bibliography',cmd:'mceGenerateBib',image:url+'/images/bibliography.png'})},getInfo:function(){return{longname:'JResearch Automatic Citation',author:'Luis Galarraga',authorurl:'',infourl:'http://joomla-research.com/docs.html',version:"2.0"}},_handleEvent:function(ed,e){var _tempcontent=ed.getContent();var marker=ed.selection.getBookmark();var matchingArray=_regexp.exec(_tempcontent);var range=ed.selection.getRng();if(!matchingArray)return true;var matchedString=matchingArray[0];var command=matchingArray[1];var citekeys=matchingArray[2];if(command==undefined||command==null||command=='')command='bibliography';var queryString="index.php?option=com_jresearch&controller=publications&task=cite&command="+command+"&citekeys="+encodeURIComponent(citekeys)+"&format=text";tinymce.util.XHR.send({url:queryString,method:"get",success:function(resultCite){if(resultCite!=''){var _tempcontent_new=_tempcontent.replace(matchedString,resultCite);ed.setContent(_tempcontent_new);marker.start+=(TinyMCE_JResearch_Automatic_Citation_Plugin._calculateRawLength(resultCite)-matchedString.length);marker.end+=(TinyMCE_JResearch_Automatic_Citation_Plugin._calculateRawLength(resultCite)-matchedString.length);ed.selection.moveToBookmark(marker)}}});return true},_calculateRawLength:function(str){var matchedArray=null;var strlength=str.length;while(true){matchedArray=_htmlTagsRegexp.exec(str);if(matchedArray==null)break;strlength-=matchedArray[0].length}return strlength}};tinymce.create('tinymce.plugins.JResearch_Automatic_Citation',TinyMCE_JResearch_Automatic_Citation_Plugin);tinymce.PluginManager.add('jresearch',tinymce.plugins.JResearch_Automatic_Citation)})();